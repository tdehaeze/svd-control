<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2020-09-30 mer. 17:15 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<title>SVD Control</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Dehaeze Thomas" />
<link rel="stylesheet" type="text/css" href="./css/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="./css/readtheorg.css"/>
<link rel="stylesheet" type="text/css" href="./css/zenburn.css"/>
<script type="text/javascript" src="./js/jquery.min.js"></script>
<script type="text/javascript" src="./js/bootstrap.min.js"></script>
<script type="text/javascript" src="./js/jquery.stickytableheaders.min.js"></script>
<script type="text/javascript" src="./js/readtheorg.js"></script>
<script>MathJax = {
          tex: {
            tags: 'ams',
            macros: {bm: ["\\boldsymbol{#1}",1],}
            }
          };
          </script>
          <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>
<body>
<div id="org-div-home-and-up">
 <a accesskey="h" href="../index.html"> UP </a>
 |
 <a accesskey="H" href="../index.html"> HOME </a>
</div><div id="content">
<h1 class="title">SVD Control</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org8605f4d">1. Gravimeter - Simscape Model</a>
<ul>
<li><a href="#orgc32c7f1">1.1. Simscape Model - Parameters</a></li>
<li><a href="#org4bab8c7">1.2. System Identification - Without Gravity</a></li>
<li><a href="#org1af907b">1.3. System Identification - With Gravity</a></li>
<li><a href="#orgf23381e">1.4. Analytical Model</a>
<ul>
<li><a href="#org86e662a">1.4.1. Parameters</a></li>
<li><a href="#orgd9883dd">1.4.2. generation of the state space model</a></li>
<li><a href="#orgf1cd403">1.4.3. Comparison with the Simscape Model</a></li>
<li><a href="#orgc44aa74">1.4.4. Analysis</a></li>
<li><a href="#org56c5430">1.4.5. Control Section</a></li>
<li><a href="#org2f4000c">1.4.6. Greshgorin radius</a></li>
<li><a href="#orgacfa62b">1.4.7. Injecting ground motion in the system to have the output</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgdbdd0b8">2. Gravimeter - Functions</a>
<ul>
<li><a href="#org72eb8fe">2.1. <code>align</code></a></li>
<li><a href="#orgf7acd4e">2.2. <code>pzmap_testCL</code></a></li>
</ul>
</li>
<li><a href="#org20de0f0">3. Stewart Platform - Simscape Model</a>
<ul>
<li><a href="#orgf01ffb3">3.1. Jacobian</a></li>
<li><a href="#orgab52d7f">3.2. Simscape Model</a></li>
<li><a href="#orgde1eb2c">3.3. Identification of the plant</a></li>
<li><a href="#orgef70e0f">3.4. Obtained Dynamics</a></li>
<li><a href="#org97d95a3">3.5. Real Approximation of \(G\) at the decoupling frequency</a></li>
<li><a href="#org2460007">3.6. Verification of the decoupling using the &ldquo;Gershgorin Radii&rdquo;</a></li>
<li><a href="#orgc89a913">3.7. Decoupled Plant</a></li>
<li><a href="#org3d3c34c">3.8. Diagonal Controller</a></li>
<li><a href="#orgaa29814">3.9. Centralized Control</a></li>
<li><a href="#orge736e6a">3.10. SVD Control</a></li>
<li><a href="#orgd1cfb41">3.11. Results</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-org8605f4d" class="outline-2">
<h2 id="org8605f4d"><span class="section-number-2">1</span> Gravimeter - Simscape Model</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-orgc32c7f1" class="outline-3">
<h3 id="orgc32c7f1"><span class="section-number-3">1.1</span> Simscape Model - Parameters</h3>
<div class="outline-text-3" id="text-1-1">
<div class="org-src-container">
<pre class="src src-matlab">open('gravimeter.slx')
</pre>
</div>

<p>
Parameters
</p>
<div class="org-src-container">
<pre class="src src-matlab">l  = 0.5; % Length of the mass [m]
la = 0.5; % Position of Act. [m]

h  = 1.7; % Height of the mass [m]
ha = 1.7; % Position of Act. [m]

m = 400; % Mass [kg]
I = 115; % Inertia [kg m^2]

k = 15e3; % Actuator Stiffness [N/m]
c = 0.03; % Actuator Damping [N/(m/s)]

deq = 0.2; % Length of the actuators [m]

g = 0; % Gravity [m/s2]
</pre>
</div>
</div>
</div>

<div id="outline-container-org4bab8c7" class="outline-3">
<h3 id="org4bab8c7"><span class="section-number-3">1.2</span> System Identification - Without Gravity</h3>
<div class="outline-text-3" id="text-1-2">
<div class="org-src-container">
<pre class="src src-matlab">%% Name of the Simulink File
mdl = 'gravimeter';

%% Input/Output definition
clear io; io_i = 1;
io(io_i) = linio([mdl, '/F1'], 1, 'openinput');  io_i = io_i + 1;
io(io_i) = linio([mdl, '/F2'], 1, 'openinput');  io_i = io_i + 1;
io(io_i) = linio([mdl, '/F3'], 1, 'openinput');  io_i = io_i + 1;
io(io_i) = linio([mdl, '/Acc_side'], 1, 'openoutput'); io_i = io_i + 1;
io(io_i) = linio([mdl, '/Acc_side'], 2, 'openoutput'); io_i = io_i + 1;
io(io_i) = linio([mdl, '/Acc_top'], 1, 'openoutput'); io_i = io_i + 1;
io(io_i) = linio([mdl, '/Acc_top'], 2, 'openoutput'); io_i = io_i + 1;

G = linearize(mdl, io);
G.InputName  = {'F1', 'F2', 'F3'};
G.OutputName = {'Ax1', 'Az1', 'Ax2', 'Az2'};
</pre>
</div>

<pre class="example">
pole(G)
ans =
      -0.000473481142385801 +      21.7596190728632i
      -0.000473481142385801 -      21.7596190728632i
      -7.49842879459177e-05 +       8.6593576906982i
      -7.49842879459177e-05 -       8.6593576906982i
      -5.15386867925747e-06 +      2.27025295182755i
      -5.15386867925747e-06 -      2.27025295182755i
</pre>

<p>
The plant as 6 states as expected (2 translations + 1 rotation)
</p>
<div class="org-src-container">
<pre class="src src-matlab">size(G)
</pre>
</div>

<pre class="example">
State-space model with 4 outputs, 3 inputs, and 6 states.
</pre>



<div id="orgb31b43a" class="figure">
<p><img src="figs/open_loop_tf.png" alt="open_loop_tf.png" />
</p>
<p><span class="figure-number">Figure 1: </span>Open Loop Transfer Function from 3 Actuators to 4 Accelerometers</p>
</div>
</div>
</div>

<div id="outline-container-org1af907b" class="outline-3">
<h3 id="org1af907b"><span class="section-number-3">1.3</span> System Identification - With Gravity</h3>
<div class="outline-text-3" id="text-1-3">
<div class="org-src-container">
<pre class="src src-matlab">g = 9.80665; % Gravity [m/s2]
</pre>
</div>

<div class="org-src-container">
<pre class="src src-matlab">Gg = linearize(mdl, io);
Gg.InputName  = {'F1', 'F2', 'F3'};
Gg.OutputName = {'Ax1', 'Az1', 'Ax2', 'Az2'};
</pre>
</div>

<p>
We can now see that the system is unstable due to gravity.
</p>
<pre class="example">
pole(G)
ans =
          -10.9848275341276 +                     0i
           10.9838836405193 +                     0i
      -7.49855396089326e-05 +      8.65962885769976i
      -7.49855396089326e-05 -      8.65962885769976i
      -6.68819341967921e-06 +      0.83296042226902i
      -6.68819341967921e-06 -      0.83296042226902i
</pre>


<div id="org6f96795" class="figure">
<p><img src="figs/open_loop_tf_g.png" alt="open_loop_tf_g.png" />
</p>
<p><span class="figure-number">Figure 2: </span>Open Loop Transfer Function from 3 Actuators to 4 Accelerometers with an without gravity</p>
</div>
</div>
</div>

<div id="outline-container-orgf23381e" class="outline-3">
<h3 id="orgf23381e"><span class="section-number-3">1.4</span> Analytical Model</h3>
<div class="outline-text-3" id="text-1-4">
</div>
<div id="outline-container-org86e662a" class="outline-4">
<h4 id="org86e662a"><span class="section-number-4">1.4.1</span> Parameters</h4>
<div class="outline-text-4" id="text-1-4-1">
<p>
Control parameters
</p>
<div class="org-src-container">
<pre class="src src-matlab">g = 1e5;
g_svd = 1e5;
</pre>
</div>

<p>
System parameters
</p>
<div class="org-src-container">
<pre class="src src-matlab">w0 = 2*pi*.5; % MinusK BM1 tablle

l  = 0.8; % [m]
la = l;   % [m]

h  = 1.7; % [m]
ha = h;   % [m]

m = 70; % [kg]

k = 3e3; % [N/m]
I = 10;  % [kg m^2]
</pre>
</div>

<p>
Bode options.
</p>
<div class="org-src-container">
<pre class="src src-matlab">P = bodeoptions;
P.FreqUnits = 'Hz';
P.MagUnits = 'abs';
P.MagScale = 'log';
P.Grid = 'on';
P.PhaseWrapping = 'on';
P.Title.FontSize = 14;
P.XLabel.FontSize = 14;
P.YLabel.FontSize = 14;
P.TickLabel.FontSize = 12;
P.Xlim = [1e-1,1e2];
P.MagLowerLimMode = 'manual';
P.MagLowerLim= 1e-3;
%P.PhaseVisible = 'off';
</pre>
</div>

<p>
Frequency vector.
</p>
<div class="org-src-container">
<pre class="src src-matlab">w = 2*pi*logspace(-1,2,1000); % [rad/s]
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd9883dd" class="outline-4">
<h4 id="orgd9883dd"><span class="section-number-4">1.4.2</span> generation of the state space model</h4>
<div class="outline-text-4" id="text-1-4-2">
<div class="org-src-container">
<pre class="src src-matlab">M = [m 0 0
     0 m 0
     0 0 I];

%Jacobian of the bottom sensor
Js1 = [1 0 h/2
       0 1 -l/2];
%Jacobian of the top sensor
Js2 = [1 0 -h/2
       0 1 0];

%Jacobian of the actuators
Ja = [1 0 ha/2 %Left horizontal actuator
               %1 0 h/2 %Right horizontal actuator
      0 1 -la/2 %Left vertical actuator
      0 1 la/2]; %Right vertical actuator
Jta = Ja';
K = k*Jta*Ja;
C = 0.06*k*Jta*Ja;

E = [1 0 0
     0 1 0
     0 0 1]; %projecting ground motion in the directions of the legs

AA = [zeros(3) eye(3)
      -M\K -M\C];

BB = [zeros(3,6)
      M\Jta M\(k*Jta*E)];

% BB = [zeros(3,3)
%     M\Jta ];
%
% CC = [Ja zeros(3)];
% DD = zeros(3,3);

CC = [[Js1;Js2] zeros(4,3);
      zeros(2,6)
      (Js1+Js2)./2 zeros(2,3)
      (Js1-Js2)./2 zeros(2,3)
      (Js1-Js2)./(2*h) zeros(2,3)];

DD = [zeros(4,6)
      zeros(2,3) eye(2,3)
      zeros(6,6)];

system_dec = ss(AA,BB,CC,DD);
</pre>
</div>

<ul class="org-ul">
<li>Input = three actuators and three ground motions</li>
<li>Output = the bottom sensor; the top sensor; the ground motion; the half sum; the half difference; the rotation</li>
</ul>

<div class="org-src-container">
<pre class="src src-matlab">size(system_dec)
</pre>
</div>

<pre class="example">
State-space model with 12 outputs, 6 inputs, and 6 states.
</pre>
</div>
</div>

<div id="outline-container-orgf1cd403" class="outline-4">
<h4 id="orgf1cd403"><span class="section-number-4">1.4.3</span> Comparison with the Simscape Model</h4>
<div class="outline-text-4" id="text-1-4-3">

<div id="org8683b2b" class="figure">
<p><img src="figs/gravimeter_analytical_system_open_loop_models.png" alt="gravimeter_analytical_system_open_loop_models.png" />
</p>
<p><span class="figure-number">Figure 3: </span>Comparison of the analytical and the Simscape models</p>
</div>
</div>
</div>

<div id="outline-container-orgc44aa74" class="outline-4">
<h4 id="orgc44aa74"><span class="section-number-4">1.4.4</span> Analysis</h4>
<div class="outline-text-4" id="text-1-4-4">
<div class="org-src-container">
<pre class="src src-matlab">% figure
% bode(system_dec,P);
% return
</pre>
</div>

<div class="org-src-container">
<pre class="src src-matlab">%% svd decomposition
% system_dec_freq = freqresp(system_dec,w);
% S = zeros(3,length(w));
% for m = 1:length(w)
%     S(:,m) = svd(system_dec_freq(1:4,1:3,m));
% end
% figure
% loglog(w./(2*pi), S);hold on;
% % loglog(w./(2*pi), abs(Val(1,:)),w./(2*pi), abs(Val(2,:)),w./(2*pi), abs(Val(3,:)));
% xlabel('Frequency [Hz]');ylabel('Singular Value [-]');
% legend('\sigma_1','\sigma_2','\sigma_3');%,'\sigma_4','\sigma_5','\sigma_6');
% ylim([1e-8 1e-2]);
%
% %condition number
% figure
% loglog(w./(2*pi), S(1,:)./S(3,:));hold on;
% % loglog(w./(2*pi), abs(Val(1,:)),w./(2*pi), abs(Val(2,:)),w./(2*pi), abs(Val(3,:)));
% xlabel('Frequency [Hz]');ylabel('Condition number [-]');
% % legend('\sigma_1','\sigma_2','\sigma_3');%,'\sigma_4','\sigma_5','\sigma_6');
%
% %performance indicator
% system_dec_svd = freqresp(system_dec(1:4,1:3),2*pi*10);
% [U,S,V] = svd(system_dec_svd);
% H_svd_OL = -eye(3,4);%-[zpk(-2*pi*10,-2*pi*40,40/10) 0 0 0; 0 10*zpk(-2*pi*40,-2*pi*200,40/200) 0 0; 0 0 zpk(-2*pi*2,-2*pi*10,10/2) 0];% - eye(3,4);%
% H_svd = pinv(V')*H_svd_OL*pinv(U);
% % system_dec_control_svd_ = feedback(system_dec,g*pinv(V')*H*pinv(U));
%
% OL_dec = g_svd*H_svd*system_dec(1:4,1:3);
% OL_freq = freqresp(OL_dec,w); % OL = G*H
% CL_system = feedback(eye(3),-g_svd*H_svd*system_dec(1:4,1:3));
% CL_freq = freqresp(CL_system,w); % CL = (1+G*H)^-1
% % CL_system_2 = feedback(system_dec,H);
% % CL_freq_2 = freqresp(CL_system_2,w); % CL = G/(1+G*H)
% for i = 1:size(w,2)
%     OL(:,i) = svd(OL_freq(:,:,i));
%     CL (:,i) = svd(CL_freq(:,:,i));
%     %CL2 (:,i) = svd(CL_freq_2(:,:,i));
% end
%
% un = ones(1,length(w));
% figure
% loglog(w./(2*pi),OL(3,:)+1,'k',w./(2*pi),OL(3,:)-1,'b',w./(2*pi),1./CL(1,:),'r--',w./(2*pi),un,'k:');hold on;%
% % loglog(w./(2*pi), 1./(CL(2,:)),w./(2*pi), 1./(CL(3,:)));
% % semilogx(w./(2*pi), 1./(CL2(1,:)),w./(2*pi), 1./(CL2(2,:)),w./(2*pi), 1./(CL2(3,:)));
% xlabel('Frequency [Hz]');ylabel('Singular Value [-]');
% legend('GH \sigma_{inf} +1 ','GH \sigma_{inf} -1','S 1/\sigma_{sup}');%,'\lambda_1','\lambda_2','\lambda_3');
%
% figure
% loglog(w./(2*pi),OL(1,:)+1,'k',w./(2*pi),OL(1,:)-1,'b',w./(2*pi),1./CL(3,:),'r--',w./(2*pi),un,'k:');hold on;%
% % loglog(w./(2*pi), 1./(CL(2,:)),w./(2*pi), 1./(CL(3,:)));
% % semilogx(w./(2*pi), 1./(CL2(1,:)),w./(2*pi), 1./(CL2(2,:)),w./(2*pi), 1./(CL2(3,:)));
% xlabel('Frequency [Hz]');ylabel('Singular Value [-]');
% legend('GH \sigma_{sup} +1 ','GH \sigma_{sup} -1','S 1/\sigma_{inf}');%,'\lambda_1','\lambda_2','\lambda_3');
</pre>
</div>
</div>
</div>

<div id="outline-container-org56c5430" class="outline-4">
<h4 id="org56c5430"><span class="section-number-4">1.4.5</span> Control Section</h4>
<div class="outline-text-4" id="text-1-4-5">
<div class="org-src-container">
<pre class="src src-matlab">system_dec_10Hz = freqresp(system_dec,2*pi*10);
system_dec_0Hz = freqresp(system_dec,0);

system_decReal_10Hz = pinv(align(system_dec_10Hz));
[Ureal,Sreal,Vreal] = svd(system_decReal_10Hz(1:4,1:3));
normalizationMatrixReal = abs(pinv(Ureal)*system_dec_0Hz(1:4,1:3)*pinv(Vreal'));

[U,S,V] = svd(system_dec_10Hz(1:4,1:3));
normalizationMatrix = abs(pinv(U)*system_dec_0Hz(1:4,1:3)*pinv(V'));

H_dec = ([zpk(-2*pi*5,-2*pi*30,30/5) 0 0 0
          0 zpk(-2*pi*4,-2*pi*20,20/4) 0 0
          0 0 0 zpk(-2*pi,-2*pi*10,10)]);
H_cen_OL = [zpk(-2*pi,-2*pi*10,10) 0 0; 0 zpk(-2*pi,-2*pi*10,10) 0;
            0 0 zpk(-2*pi*5,-2*pi*30,30/5)];
H_cen = pinv(Jta)*H_cen_OL*pinv([Js1; Js2]);
% H_svd_OL = -[1/normalizationMatrix(1,1) 0 0 0
%     0 1/normalizationMatrix(2,2) 0 0
%     0 0 1/normalizationMatrix(3,3) 0];
% H_svd_OL_real = -[1/normalizationMatrixReal(1,1) 0 0 0
%     0 1/normalizationMatrixReal(2,2) 0 0
%     0 0 1/normalizationMatrixReal(3,3) 0];
H_svd_OL = -[1/normalizationMatrix(1,1)*zpk(-2*pi*10,-2*pi*60,60/10) 0 0 0
             0 1/normalizationMatrix(2,2)*zpk(-2*pi*5,-2*pi*30,30/5) 0 0
             0 0 1/normalizationMatrix(3,3)*zpk(-2*pi*2,-2*pi*10,10/2) 0];
H_svd_OL_real = -[1/normalizationMatrixReal(1,1)*zpk(-2*pi*10,-2*pi*60,60/10) 0 0 0
                  0 1/normalizationMatrixReal(2,2)*zpk(-2*pi*5,-2*pi*30,30/5) 0 0
                  0 0 1/normalizationMatrixReal(3,3)*zpk(-2*pi*2,-2*pi*10,10/2) 0];
% H_svd_OL_real = -[zpk(-2*pi*10,-2*pi*40,40/10) 0 0 0; 0 10*zpk(-2*pi*10,-2*pi*100,100/10) 0 0; 0 0 zpk(-2*pi*2,-2*pi*10,10/2) 0];%-eye(3,4);
% H_svd_OL = -[zpk(-2*pi*10,-2*pi*40,40/10) 0 0 0; 0 zpk(-2*pi*4,-2*pi*20,4/20) 0 0; 0 0 zpk(-2*pi*2,-2*pi*10,10/2) 0];% - eye(3,4);%
H_svd = pinv(V')*H_svd_OL*pinv(U);
H_svd_real = pinv(Vreal')*H_svd_OL_real*pinv(Ureal);

OL_dec = g*H_dec*system_dec(1:4,1:3);
OL_cen = g*H_cen_OL*pinv([Js1; Js2])*system_dec(1:4,1:3)*pinv(Jta);
OL_svd = 100*H_svd_OL*pinv(U)*system_dec(1:4,1:3)*pinv(V');
OL_svd_real = 100*H_svd_OL_real*pinv(Ureal)*system_dec(1:4,1:3)*pinv(Vreal');
</pre>
</div>

<div class="org-src-container">
<pre class="src src-matlab">% figure
% bode(OL_dec,w,P);title('OL Decentralized');
% figure
% bode(OL_cen,w,P);title('OL Centralized');
</pre>
</div>

<div class="org-src-container">
<pre class="src src-matlab">figure
bode(g*system_dec(1:4,1:3),w,P);
title('gain * Plant');
</pre>
</div>

<div class="org-src-container">
<pre class="src src-matlab">figure
bode(OL_svd,OL_svd_real,w,P);
title('OL SVD');
legend('SVD of Complex plant','SVD of real approximation of the complex plant')
</pre>
</div>

<div class="org-src-container">
<pre class="src src-matlab">figure
bode(system_dec(1:4,1:3),pinv(U)*system_dec(1:4,1:3)*pinv(V'),P);
</pre>
</div>

<div class="org-src-container">
<pre class="src src-matlab">CL_dec = feedback(system_dec,g*H_dec,[1 2 3],[1 2 3 4]);
CL_cen = feedback(system_dec,g*H_cen,[1 2 3],[1 2 3 4]);
CL_svd = feedback(system_dec,100*H_svd,[1 2 3],[1 2 3 4]);
CL_svd_real = feedback(system_dec,100*H_svd_real,[1 2 3],[1 2 3 4]);
</pre>
</div>

<div class="org-src-container">
<pre class="src src-matlab">pzmap_testCL(system_dec,H_dec,g,[1 2 3],[1 2 3 4])
title('Decentralized control');
</pre>
</div>

<div class="org-src-container">
<pre class="src src-matlab">pzmap_testCL(system_dec,H_cen,g,[1 2 3],[1 2 3 4])
title('Centralized control');
</pre>
</div>

<div class="org-src-container">
<pre class="src src-matlab">pzmap_testCL(system_dec,H_svd,100,[1 2 3],[1 2 3 4])
title('SVD control');
</pre>
</div>

<div class="org-src-container">
<pre class="src src-matlab">pzmap_testCL(system_dec,H_svd_real,100,[1 2 3],[1 2 3 4])
title('Real approximation SVD control');
</pre>
</div>

<div class="org-src-container">
<pre class="src src-matlab">P.Ylim = [1e-8 1e-3];
figure
bodemag(system_dec(1:4,1:3),CL_dec(1:4,1:3),CL_cen(1:4,1:3),CL_svd(1:4,1:3),CL_svd_real(1:4,1:3),P);
title('Motion/actuator')
legend('Control OFF','Decentralized control','Centralized control','SVD control','SVD control real appr.');
</pre>
</div>

<div class="org-src-container">
<pre class="src src-matlab">P.Ylim = [1e-5 1e1];
figure
bodemag(system_dec(1:4,4:6),CL_dec(1:4,4:6),CL_cen(1:4,4:6),CL_svd(1:4,4:6),CL_svd_real(1:4,4:6),P);
title('Transmissibility');
legend('Control OFF','Decentralized control','Centralized control','SVD control','SVD control real appr.');
</pre>
</div>

<div class="org-src-container">
<pre class="src src-matlab">figure
bodemag(system_dec([7 9],4:6),CL_dec([7 9],4:6),CL_cen([7 9],4:6),CL_svd([7 9],4:6),CL_svd_real([7 9],4:6),P);
title('Transmissibility from half sum and half difference in the X direction');
legend('Control OFF','Decentralized control','Centralized control','SVD control','SVD control real appr.');
</pre>
</div>

<div class="org-src-container">
<pre class="src src-matlab">figure
bodemag(system_dec([8 10],4:6),CL_dec([8 10],4:6),CL_cen([8 10],4:6),CL_svd([8 10],4:6),CL_svd_real([8 10],4:6),P);
title('Transmissibility from half sum and half difference in the Z direction');
legend('Control OFF','Decentralized control','Centralized control','SVD control','SVD control real appr.');
</pre>
</div>
</div>
</div>

<div id="outline-container-org2f4000c" class="outline-4">
<h4 id="org2f4000c"><span class="section-number-4">1.4.6</span> Greshgorin radius</h4>
<div class="outline-text-4" id="text-1-4-6">
<div class="org-src-container">
<pre class="src src-matlab">system_dec_freq = freqresp(system_dec,w);
x1 = zeros(1,length(w));
z1 = zeros(1,length(w));
x2 = zeros(1,length(w));
S1 = zeros(1,length(w));
S2 = zeros(1,length(w));
S3 = zeros(1,length(w));

for t = 1:length(w)
    x1(t) = (abs(system_dec_freq(1,2,t))+abs(system_dec_freq(1,3,t)))/abs(system_dec_freq(1,1,t));
    z1(t) = (abs(system_dec_freq(2,1,t))+abs(system_dec_freq(2,3,t)))/abs(system_dec_freq(2,2,t));
    x2(t) = (abs(system_dec_freq(3,1,t))+abs(system_dec_freq(3,2,t)))/abs(system_dec_freq(3,3,t));
    system_svd = pinv(Ureal)*system_dec_freq(1:4,1:3,t)*pinv(Vreal');
    S1(t) = (abs(system_svd(1,2))+abs(system_svd(1,3)))/abs(system_svd(1,1));
    S2(t) = (abs(system_svd(2,1))+abs(system_svd(2,3)))/abs(system_svd(2,2));
    S2(t) = (abs(system_svd(3,1))+abs(system_svd(3,2)))/abs(system_svd(3,3));
end

limit = 0.5*ones(1,length(w));
</pre>
</div>

<div class="org-src-container">
<pre class="src src-matlab">figure
loglog(w./(2*pi),x1,w./(2*pi),z1,w./(2*pi),x2,w./(2*pi),limit,'--');
legend('x_1','z_1','x_2','Limit');
xlabel('Frequency [Hz]');
ylabel('Greshgorin radius [-]');
</pre>
</div>

<div class="org-src-container">
<pre class="src src-matlab">figure
loglog(w./(2*pi),S1,w./(2*pi),S2,w./(2*pi),S3,w./(2*pi),limit,'--');
legend('S1','S2','S3','Limit');
xlabel('Frequency [Hz]');
ylabel('Greshgorin radius [-]');
% set(gcf,'color','w')
</pre>
</div>
</div>
</div>

<div id="outline-container-orgacfa62b" class="outline-4">
<h4 id="orgacfa62b"><span class="section-number-4">1.4.7</span> Injecting ground motion in the system to have the output</h4>
<div class="outline-text-4" id="text-1-4-7">
<div class="org-src-container">
<pre class="src src-matlab">Fr = logspace(-2,3,1e3);
w=2*pi*Fr*1i;
%fit of the ground motion data in m/s^2/rtHz
Fr_ground_x = [0.07 0.1 0.15 0.3 0.7 0.8 0.9 1.2 5 10];
n_ground_x1 = [4e-7 4e-7 2e-6 1e-6 5e-7 5e-7 5e-7 1e-6 1e-5 3.5e-5];
Fr_ground_v = [0.07 0.08 0.1 0.11 0.12 0.15 0.25 0.6 0.8 1 1.2 1.6 2 6 10];
n_ground_v1 = [7e-7 7e-7 7e-7 1e-6 1.2e-6 1.5e-6 1e-6 9e-7 7e-7 7e-7 7e-7 1e-6 2e-6 1e-5 3e-5];

n_ground_x = interp1(Fr_ground_x,n_ground_x1,Fr,'linear');
n_ground_v = interp1(Fr_ground_v,n_ground_v1,Fr,'linear');
% figure
% loglog(Fr,abs(n_ground_v),Fr_ground_v,n_ground_v1,'*');
% xlabel('Frequency [Hz]');ylabel('ASD [m/s^2 /rtHz]');
% return

%converting into PSD
n_ground_x = (n_ground_x).^2;
n_ground_v = (n_ground_v).^2;

%Injecting ground motion in the system and getting the outputs
system_dec_f = (freqresp(system_dec,abs(w)));
PHI = zeros(size(Fr,2),12,12);
for p = 1:size(Fr,2)
    Sw=zeros(6,6);
    Iact = zeros(3,3);
    Sw(4,4) = n_ground_x(p);
    Sw(5,5) = n_ground_v(p);
    Sw(6,6) = n_ground_v(p);
    Sw(1:3,1:3) = Iact;
    PHI(p,:,:) = (system_dec_f(:,:,p))*Sw(:,:)*(system_dec_f(:,:,p))';
end
x1 = PHI(:,1,1);
z1 = PHI(:,2,2);
x2 = PHI(:,3,3);
z2 = PHI(:,4,4);
wx = PHI(:,5,5);
wz = PHI(:,6,6);
x12 = PHI(:,1,3);
z12 = PHI(:,2,4);
PHIwx = PHI(:,1,5);
PHIwz = PHI(:,2,6);
xsum = PHI(:,7,7);
zsum = PHI(:,8,8);
xdelta = PHI(:,9,9);
zdelta = PHI(:,10,10);
rot = PHI(:,11,11);
</pre>
</div>
</div>
</div>
</div>
</div>

<div id="outline-container-orgdbdd0b8" class="outline-2">
<h2 id="orgdbdd0b8"><span class="section-number-2">2</span> Gravimeter - Functions</h2>
<div class="outline-text-2" id="text-2">
</div>
<div id="outline-container-org72eb8fe" class="outline-3">
<h3 id="org72eb8fe"><span class="section-number-3">2.1</span> <code>align</code></h3>
<div class="outline-text-3" id="text-2-1">
<p>
<a id="orgdf12c8c"></a>
</p>

<p>
This Matlab function is accessible <a href="gravimeter/align.m">here</a>.
</p>

<div class="org-src-container">
<pre class="src src-matlab">function [A] = align(V)
%A!ALIGN(V) returns a constat matrix A which is the real alignment of the
%INVERSE of the complex input matrix V
%from Mohit slides

    if (nargin ==0) || (nargin &gt; 1)
        disp('usage: mat_inv_real = align(mat)')
        return
    end

    D = pinv(real(V'*V));
    A = D*real(V'*diag(exp(1i * angle(diag(V*D*V.'))/2)));


end
</pre>
</div>
</div>
</div>


<div id="outline-container-orgf7acd4e" class="outline-3">
<h3 id="orgf7acd4e"><span class="section-number-3">2.2</span> <code>pzmap_testCL</code></h3>
<div class="outline-text-3" id="text-2-2">
<p>
<a id="org8d6e185"></a>
</p>

<p>
This Matlab function is accessible <a href="gravimeter/pzmap_testCL.m">here</a>.
</p>

<div class="org-src-container">
<pre class="src src-matlab">function [] = pzmap_testCL(system,H,gain,feedin,feedout)
% evaluate and plot the pole-zero map for the closed loop system for
% different values of the gain

    [~, n] = size(gain);
    [m1, n1, ~] = size(H);
    [~,n2] = size(feedin);

    figure
    for i = 1:n
        %     if n1 == n2
        system_CL = feedback(system,gain(i)*H,feedin,feedout);

        [P,Z] = pzmap(system_CL);
        plot(real(P(:)),imag(P(:)),'x',real(Z(:)),imag(Z(:)),'o');hold on
        xlabel('Real axis (s^{-1})');ylabel('Imaginary Axis (s^{-1})');
        %         clear P Z
        %     else
        %         system_CL = feedback(system,gain(i)*H(:,1+(i-1)*m1:m1+(i-1)*m1),feedin,feedout);
        %
        %         [P,Z] = pzmap(system_CL);
        %         plot(real(P(:)),imag(P(:)),'x',real(Z(:)),imag(Z(:)),'o');hold on
        %         xlabel('Real axis (s^{-1})');ylabel('Imaginary Axis (s^{-1})');
        %         clear P Z
        %     end
    end
    str = {strcat('gain = ' , num2str(gain(1)))};  % at the end of first loop, z being loop output
    str = [str , strcat('gain = ' , num2str(gain(1)))]; % after 2nd loop
    for i = 2:n
        str = [str , strcat('gain = ' , num2str(gain(i)))]; % after 2nd loop
        str = [str , strcat('gain = ' , num2str(gain(i)))]; % after 2nd loop
    end
    legend(str{:})
end

</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org20de0f0" class="outline-2">
<h2 id="org20de0f0"><span class="section-number-2">3</span> Stewart Platform - Simscape Model</h2>
<div class="outline-text-2" id="text-3">
</div>
<div id="outline-container-orgf01ffb3" class="outline-3">
<h3 id="orgf01ffb3"><span class="section-number-3">3.1</span> Jacobian</h3>
<div class="outline-text-3" id="text-3-1">
<p>
First, the position of the &ldquo;joints&rdquo; (points of force application) are estimated and the Jacobian computed.
</p>
<div class="org-src-container">
<pre class="src src-matlab">open('stewart_platform/drone_platform_jacobian.slx');
</pre>
</div>

<div class="org-src-container">
<pre class="src src-matlab">sim('drone_platform_jacobian');
</pre>
</div>

<div class="org-src-container">
<pre class="src src-matlab">Aa = [a1.Data(1,:);
      a2.Data(1,:);
      a3.Data(1,:);
      a4.Data(1,:);
      a5.Data(1,:);
      a6.Data(1,:)]';

Ab = [b1.Data(1,:);
      b2.Data(1,:);
      b3.Data(1,:);
      b4.Data(1,:);
      b5.Data(1,:);
      b6.Data(1,:)]';

As = (Ab - Aa)./vecnorm(Ab - Aa);

l = vecnorm(Ab - Aa)';

J = [As' , cross(Ab, As)'];

save('./jacobian.mat', 'Aa', 'Ab', 'As', 'l', 'J');
</pre>
</div>
</div>
</div>

<div id="outline-container-orgab52d7f" class="outline-3">
<h3 id="orgab52d7f"><span class="section-number-3">3.2</span> Simscape Model</h3>
<div class="outline-text-3" id="text-3-2">
<div class="org-src-container">
<pre class="src src-matlab">open('stewart_platform/drone_platform.slx');
</pre>
</div>

<p>
Definition of spring parameters
</p>
<div class="org-src-container">
<pre class="src src-matlab">kx = 50; % [N/m]
ky = 50;
kz = 50;

cx = 0.025; % [Nm/rad]
cy = 0.025;
cz = 0.025;
</pre>
</div>

<p>
We load the Jacobian.
</p>
<div class="org-src-container">
<pre class="src src-matlab">load('./jacobian.mat', 'Aa', 'Ab', 'As', 'l', 'J');
</pre>
</div>
</div>
</div>

<div id="outline-container-orgde1eb2c" class="outline-3">
<h3 id="orgde1eb2c"><span class="section-number-3">3.3</span> Identification of the plant</h3>
<div class="outline-text-3" id="text-3-3">
<p>
The dynamics is identified from forces applied by each legs to the measured acceleration of the top platform.
</p>
<div class="org-src-container">
<pre class="src src-matlab">%% Name of the Simulink File
mdl = 'drone_platform';

%% Input/Output definition
clear io; io_i = 1;
io(io_i) = linio([mdl, '/Dw'],              1, 'openinput');  io_i = io_i + 1;
io(io_i) = linio([mdl, '/u'],               1, 'openinput');  io_i = io_i + 1;
io(io_i) = linio([mdl, '/Inertial Sensor'], 1, 'openoutput'); io_i = io_i + 1;

G = linearize(mdl, io);
G.InputName  = {'Dwx', 'Dwy', 'Dwz', 'Rwx', 'Rwy', 'Rwz', ...
                'F1', 'F2', 'F3', 'F4', 'F5', 'F6'};
G.OutputName = {'Ax', 'Ay', 'Az', 'Arx', 'Ary', 'Arz'};
</pre>
</div>

<p>
There are 24 states (6dof for the bottom platform + 6dof for the top platform).
</p>
<div class="org-src-container">
<pre class="src src-matlab">size(G)
</pre>
</div>

<pre class="example">
State-space model with 6 outputs, 12 inputs, and 24 states.
</pre>


<div class="org-src-container">
<pre class="src src-matlab">% G = G*blkdiag(inv(J), eye(6));
% G.InputName  = {'Dw1', 'Dw2', 'Dw3', 'Dw4', 'Dw5', 'Dw6', ...
%                 'F1', 'F2', 'F3', 'F4', 'F5', 'F6'};
</pre>
</div>

<p>
Thanks to the Jacobian, we compute the transfer functions in the frame of the legs and in an inertial frame.
</p>
<div class="org-src-container">
<pre class="src src-matlab">Gx = G*blkdiag(eye(6), inv(J'));
Gx.InputName  = {'Dwx', 'Dwy', 'Dwz', 'Rwx', 'Rwy', 'Rwz', ...
                 'Fx', 'Fy', 'Fz', 'Mx', 'My', 'Mz'};

Gl = J*G;
Gl.OutputName  = {'A1', 'A2', 'A3', 'A4', 'A5', 'A6'};
</pre>
</div>
</div>
</div>

<div id="outline-container-orgef70e0f" class="outline-3">
<h3 id="orgef70e0f"><span class="section-number-3">3.4</span> Obtained Dynamics</h3>
<div class="outline-text-3" id="text-3-4">

<div id="orgc85aa05" class="figure">
<p><img src="figs/stewart_platform_translations.png" alt="stewart_platform_translations.png" />
</p>
<p><span class="figure-number">Figure 4: </span>Stewart Platform Plant from forces applied by the legs to the acceleration of the platform</p>
</div>


<div id="orgc6ee760" class="figure">
<p><img src="figs/stewart_platform_rotations.png" alt="stewart_platform_rotations.png" />
</p>
<p><span class="figure-number">Figure 5: </span>Stewart Platform Plant from torques applied by the legs to the angular acceleration of the platform</p>
</div>


<div id="orgf90a83f" class="figure">
<p><img src="figs/stewart_platform_legs.png" alt="stewart_platform_legs.png" />
</p>
<p><span class="figure-number">Figure 6: </span>Stewart Platform Plant from forces applied by the legs to displacement of the legs</p>
</div>


<div id="org2b2322b" class="figure">
<p><img src="figs/stewart_platform_transmissibility.png" alt="stewart_platform_transmissibility.png" />
</p>
<p><span class="figure-number">Figure 7: </span>Transmissibility</p>
</div>
</div>
</div>

<div id="outline-container-org97d95a3" class="outline-3">
<h3 id="org97d95a3"><span class="section-number-3">3.5</span> Real Approximation of \(G\) at the decoupling frequency</h3>
<div class="outline-text-3" id="text-3-5">
<p>
Let&rsquo;s compute a real approximation of the complex matrix \(H_1\) which corresponds to the the transfer function \(G_c(j\omega_c)\) from forces applied by the actuators to the measured acceleration of the top platform evaluated at the frequency \(\omega_c\).
</p>
<div class="org-src-container">
<pre class="src src-matlab">wc = 2*pi*20; % Decoupling frequency [rad/s]

Gc = G({'Ax', 'Ay', 'Az', 'Arx', 'Ary', 'Arz'}, ...
       {'F1', 'F2', 'F3', 'F4', 'F5', 'F6'}); % Transfer function to find a real approximation

H1 = evalfr(Gc, j*wc);
</pre>
</div>

<p>
The real approximation is computed as follows:
</p>
<div class="org-src-container">
<pre class="src src-matlab">D = pinv(real(H1'*H1));
H1 = inv(D*real(H1'*diag(exp(j*angle(diag(H1*D*H1.'))/2))));
</pre>
</div>
</div>
</div>

<div id="outline-container-org2460007" class="outline-3">
<h3 id="org2460007"><span class="section-number-3">3.6</span> Verification of the decoupling using the &ldquo;Gershgorin Radii&rdquo;</h3>
<div class="outline-text-3" id="text-3-6">
<p>
First, the Singular Value Decomposition of \(H_1\) is performed:
\[ H_1 = U \Sigma V^H \]
</p>

<div class="org-src-container">
<pre class="src src-matlab">[U,S,V] = svd(H1);
</pre>
</div>

<p>
Then, the &ldquo;Gershgorin Radii&rdquo; is computed for the plant \(G_c(s)\) and the &ldquo;SVD Decoupled Plant&rdquo; \(G_d(s)\):
\[ G_d(s) = U^T G_c(s) V \]
</p>

<p>
This is computed over the following frequencies.
</p>
<div class="org-src-container">
<pre class="src src-matlab">freqs = logspace(-2, 2, 1000); % [Hz]
</pre>
</div>

<p>
Gershgorin Radii for the coupled plant:
</p>
<div class="org-src-container">
<pre class="src src-matlab">Gr_coupled = zeros(length(freqs), size(Gc,2));

H = abs(squeeze(freqresp(Gc, freqs, 'Hz')));
for out_i = 1:size(Gc,2)
    Gr_coupled(:, out_i) = squeeze((sum(H(out_i,:,:)) - H(out_i,out_i,:))./H(out_i, out_i, :));
end
</pre>
</div>

<p>
Gershgorin Radii for the decoupled plant using SVD:
</p>
<div class="org-src-container">
<pre class="src src-matlab">Gd = U'*Gc*V;
Gr_decoupled = zeros(length(freqs), size(Gd,2));

H = abs(squeeze(freqresp(Gd, freqs, 'Hz')));
for out_i = 1:size(Gd,2)
    Gr_decoupled(:, out_i) = squeeze((sum(H(out_i,:,:)) - H(out_i,out_i,:))./H(out_i, out_i, :));
end
</pre>
</div>

<p>
Gershgorin Radii for the decoupled plant using the Jacobian:
</p>
<div class="org-src-container">
<pre class="src src-matlab">Gj = Gc*inv(J');
Gr_jacobian = zeros(length(freqs), size(Gj,2));

H = abs(squeeze(freqresp(Gj, freqs, 'Hz')));

for out_i = 1:size(Gj,2)
    Gr_jacobian(:, out_i) = squeeze((sum(H(out_i,:,:)) - H(out_i,out_i,:))./H(out_i, out_i, :));
end
</pre>
</div>


<div id="org12b2460" class="figure">
<p><img src="figs/simscape_model_gershgorin_radii.png" alt="simscape_model_gershgorin_radii.png" />
</p>
<p><span class="figure-number">Figure 8: </span>Gershgorin Radii of the Coupled and Decoupled plants</p>
</div>
</div>
</div>

<div id="outline-container-orgc89a913" class="outline-3">
<h3 id="orgc89a913"><span class="section-number-3">3.7</span> Decoupled Plant</h3>
<div class="outline-text-3" id="text-3-7">
<p>
Let&rsquo;s see the bode plot of the decoupled plant \(G_d(s)\).
\[ G_d(s) = U^T G_c(s) V \]
</p>


<div id="org46c3f4b" class="figure">
<p><img src="figs/simscape_model_decoupled_plant_svd.png" alt="simscape_model_decoupled_plant_svd.png" />
</p>
<p><span class="figure-number">Figure 9: </span>Decoupled Plant using SVD</p>
</div>


<div id="org69887b2" class="figure">
<p><img src="figs/simscape_model_decoupled_plant_jacobian.png" alt="simscape_model_decoupled_plant_jacobian.png" />
</p>
<p><span class="figure-number">Figure 10: </span>Decoupled Plant using the Jacobian</p>
</div>
</div>
</div>

<div id="outline-container-org3d3c34c" class="outline-3">
<h3 id="org3d3c34c"><span class="section-number-3">3.8</span> Diagonal Controller</h3>
<div class="outline-text-3" id="text-3-8">
<p>
The controller \(K\) is a diagonal controller consisting a low pass filters with a crossover frequency \(\omega_c\) and a DC gain \(C_g\).
</p>

<div class="org-src-container">
<pre class="src src-matlab">wc = 2*pi*0.1; % Crossover Frequency [rad/s]
C_g = 50; % DC Gain

K = eye(6)*C_g/(s+wc);
</pre>
</div>
</div>
</div>

<div id="outline-container-orgaa29814" class="outline-3">
<h3 id="orgaa29814"><span class="section-number-3">3.9</span> Centralized Control</h3>
<div class="outline-text-3" id="text-3-9">
<p>
The control diagram for the centralized control is shown below.
</p>

<p>
The controller \(K_c\) is &ldquo;working&rdquo; in an cartesian frame.
The Jacobian is used to convert forces in the cartesian frame to forces applied by the actuators.
</p>


<div class="figure">
<p><img src="figs/centralized_control.png" alt="centralized_control.png" />
</p>
</div>

<div class="org-src-container">
<pre class="src src-matlab">G_cen = feedback(G, inv(J')*K, [7:12], [1:6]);
</pre>
</div>
</div>
</div>

<div id="outline-container-orge736e6a" class="outline-3">
<h3 id="orge736e6a"><span class="section-number-3">3.10</span> SVD Control</h3>
<div class="outline-text-3" id="text-3-10">
<p>
The SVD control architecture is shown below.
The matrices \(U\) and \(V\) are used to decoupled the plant \(G\).
</p>


<div class="figure">
<p><img src="figs/svd_control.png" alt="svd_control.png" />
</p>
</div>

<p>
SVD Control
</p>
<div class="org-src-container">
<pre class="src src-matlab">G_svd = feedback(G, pinv(V')*K*pinv(U), [7:12], [1:6]);
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd1cfb41" class="outline-3">
<h3 id="orgd1cfb41"><span class="section-number-3">3.11</span> Results</h3>
<div class="outline-text-3" id="text-3-11">
<p>
Let&rsquo;s first verify the stability of the closed-loop systems:
</p>
<div class="org-src-container">
<pre class="src src-matlab">isstable(G_cen)
</pre>
</div>

<pre class="example">
ans =
  logical
   1
</pre>


<div class="org-src-container">
<pre class="src src-matlab">isstable(G_svd)
</pre>
</div>

<pre class="example">
ans =
  logical
   1
</pre>


<p>
The obtained transmissibility in Open-loop, for the centralized control as well as for the SVD control are shown in Figure <a href="#orgce89643">13</a>.
</p>


<div id="orgce89643" class="figure">
<p><img src="figs/stewart_platform_simscape_cl_transmissibility.png" alt="stewart_platform_simscape_cl_transmissibility.png" />
</p>
<p><span class="figure-number">Figure 13: </span>Obtained Transmissibility</p>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Dehaeze Thomas</p>
<p class="date">Created: 2020-09-30 mer. 17:15</p>
</div>
</body>
</html>
